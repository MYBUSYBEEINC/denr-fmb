@using System.Security.Claims;
@model FMB_CIS.Models.ViewModel
@{
    Layout = "~/Views/Shared/_MainPageLayout.cshtml";
    ViewBag.Title = "Manage Applications";
    ViewBag.Role = ((ClaimsIdentity)User.Identity).FindFirst("userRole").Value;
    ViewBag.UserType = ((ClaimsIdentity)User.Identity).FindFirst("userRole").Value;
}

<link rel="stylesheet" href="~/js/DataTable/dataTables.min.css">
<script src="~/js/jquery/jquery-3.7.1/jquery-3.7.1.js"></script>
<script src="~/js/DataTable/dataTables.min.js"></script>

<style>
    .progress {
        height: 5px;
    }

    .progress-text {
        display: flex;
    }

    .progress-status {
        flex: 1;
    }

    .progress-count {
    }
</style>

<div id="card-container">
    <div id="card">
        <h2>Authority to Rent</h2>
        <button type="button" id="btnAdd" class="btn btn-primary float-end" onclick="window.location.href = '@Url.Action("Index", "ChainsawOwner")'">Add New <i data-feather="plus"></i></button>
        <table class="table dataTable" style="width:100%">
            <thead>
                <tr>
                    <th class="hidden-column">
                        ID
                    </th>
                    <th>
                        Reference Number
                    </th>
                    <th>
                        Application Date
                    </th>
                    <th>
                        Quantity
                    </th>
                    <th>
                        Permit Status
                    </th>
                    <th>
                        @* Proof of Payment *@
                        Remarks
                    </th>
                    <th>
                        Action
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (ApplicantListViewModel item in Model.applicantListViewModels)
                {
                    @if (DateTime.Now >= item.date_of_expiration)
                    {
                        <tr class="text-danger">
                            <td class="hidden-column">
                                @Html.DisplayFor(modelItem => item.id)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.ReferenceNo)
                            </td>

                            <td>
                                @Html.DisplayFor(modelItem => item.applicationDate)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.qty)
                            </td>
                            <td>
                                <div class="progress-text text-danger">
                                    <span class="progress-status">
                                        Expired
                                    </span>
                                    <span class="progress-count">
                                        @* @Html.DisplayFor(modelItem => item.currentStepCount) /
                                @Html.DisplayFor(modelItem => item.currentMaxCount) *@
                                    </span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: @Html.DisplayFor(modelItem => item.currentPercentage)%" aria-valuenow="@Html.DisplayFor(modelItem => item.currentStepCount)" aria-valuemin="@Html.DisplayFor(modelItem => item.currentStepCount)" aria-valuemax="@Html.DisplayFor(modelItem => item.currentMaxCount)"></div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex justify-content-center">Permit Expired</div>
                            </td>
                            <td>
                                <a href="../Application/EditApplication?uid=@item.tbl_user_id&appid=@item.id">View</a>
                            </td>
                        </tr>
                    }
                    else
                    {
                        <tr>
                            <td class="hidden-column">
                                @Html.DisplayFor(modelItem => item.id)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.ReferenceNo)
                            </td>

                            <td>
                                @Html.DisplayFor(modelItem => item.applicationDate)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.qty)
                            </td>
                            <td>
                                <div class="progress-text @(item.currentPercentage == 100 ? "progress-text-complete" : "")">
                                    <span class="progress-status">
                                        @Html.DisplayFor(modelItem => item.permit_statuses)
                                    </span>
                                    <span class="progress-count">
                                        @Html.DisplayFor(modelItem => item.currentStepCount) /
                                        @Html.DisplayFor(modelItem => item.currentMaxCount)
                                    </span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar @(item.currentPercentage == 100 ? "complete-progress-bar" : "")" role="progressbar" style="width: @Html.DisplayFor(modelItem => item.currentPercentage)%" aria-valuenow="@Html.DisplayFor(modelItem => item.currentStepCount)" aria-valuemin="@Html.DisplayFor(modelItem => item.currentStepCount)" aria-valuemax="@Html.DisplayFor(modelItem => item.currentMaxCount)"></div>
                                </div>
                            </td>
                            <td>
                       @*          @if (item.permit_status_id == 6 || item.permit_status_id == 8 || item.permit_status_id == 10)
                                {
                                    <div class="d-flex">
                                        <a href="#" id="uploadPOP" class="bg-green text-white pt-0 pb-1 px-2 rounded text-decoration-none" data-application-id="@item.id" onclick="uploadPaymentClicked(this)">
                                            <i data-feather="upload" class="data-feather-20"></i> Upload
                                        </a>
                                    </div>
                                }
                                else if (item.permit_status_id == 7 || item.permit_status_id == 9)
                                {
                                    <div class="d-flex">Payment Verification In Progress</div>
                                }
                                else if (item.permit_status_id == 11)
                                {
                                    <div class="d-flex">Payment Approved</div>
                                }
                                else
                                {
                                    <div class="d-flex">Not Yet Approved for Payment</div>
                                } *@
                                @if (item.permit_statuses == "For Evaluation")
                                {
                                    <div class="d-flex justify-content-center">Evaluation of Application Ongoing</div>
                                }
                                else if (item.permit_statuses == "For Physical Inspection")
                                {
                                    <div class="d-flex justify-content-center">Proceed to your DENR Office</div>
                                }
                                else if (item.permit_statuses == "For Payment")
                                {
                                    <div class="d-flex">
                                        <a href="#" id="uploadPOP" class="bg-green text-white pt-0 pb-1 px-2 rounded text-decoration-none" data-application-id="@item.id" onclick="uploadPaymentClicked(this)">
                                            <i data-feather="upload" class="data-feather-20"></i> Upload Receipt
                                        </a>
                                    </div>
                                }
                                else if (item.permit_statuses == "For Permit Approval")
                                {
                                    <div class="d-flex justify-content-center">For approval of DENR</div>
                                }
                                else if (item.permit_statuses == "For Permit Issuance")
                                {
                                    <div class="d-flex justify-content-center">For claiming at your DENR Office</div>
                                }
                                else
                                {
                                    <div class="d-flex justify-content-center">Proceed to your DENR Office</div>
                                }
                            </td>
                            <td>
                                <a href="../Application/EditApplication?uid=@item.tbl_user_id&appid=@item.id">View</a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<script src="/js/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="text/javascript">

    function uploadPaymentClicked(that) {
        //console.log("Test 1");
        $("#uploadPOPModal").modal("show");
        //console.log("Test 2");
        //console.log(that);
        //console.log(that.dataset.applicationId);
        var applicID = that.dataset.applicationId;
        document.getElementById("applicationID").value = applicID;
    }
</script>